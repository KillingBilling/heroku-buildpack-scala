#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path

# parse args
BUILD_DIR=$(cd $1; pwd)
CACHE_DIR=$2

# home directory from perspective of SBT; we rename
# it because otherwise the project root and $HOME
# are the same, and by default .sbt has a (different)
# meaning in those two places
SBT_USER_HOME=".sbt_home"
SBT_USER_HOME_ABSOLUTE="$BUILD_DIR/$SBT_USER_HOME"
# where we put the SBT binaries
SBT_BINDIR="$SBT_USER_HOME"/sbt-extras

mkdir -p $SBT_USER_HOME_ABSOLUTE
cd $SBT_USER_HOME_ABSOLUTE
git clone git://github.com/paulp/sbt-extras.git

# chdir as sbt expects
cd $BUILD_DIR

if ! test -e project/build.properties; then
	echo " !      Error, your scala project must include project/build.properties and define sbt.version"
	echo " !      You must use a release verison of sbt, sbt.version=0.11.0 or greater"
        exit 1
fi

SBT_TASKS="clean compile stage"

if [ ! -d .ivy2/cache ]; then
   mkdir -p .ivy2/cache
fi

# build app
echo "-----> Running: sbt $SBT_TASKS"

HOME="$SBT_USER_HOME_ABSOLUTE" $SBT_BINDIR/sbt -Duser.home="$SBT_USER_HOME_ABSOLUTE" -Dsbt.log.noformat=true $SBT_TASKS 2>&1 | sed -u 's/^/       /'
if [ "${PIPESTATUS[*]}" != "0 0" ]; then
  echo " !     Failed to build app with sbt"
  exit 1
fi

# remove ivy cache
rm -rf $SBT_USER_HOME/.ivy2
